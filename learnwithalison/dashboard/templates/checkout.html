{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block content %}

<script src="https://js.paystack.co/v1/inline.js"></script>

<main>

  <!-- HERO -->
  <div class="hero-arera course-item-height">
    <div class="container">
      <h2 class="text-center">Checkout</h2>
    </div>
  </div>

  <!-- CHECKOUT -->
  <section class="cart-area pt-100 pb-100">
    <div class="container">

      <div class="row">

        <!-- ORDER SUMMARY -->
        <div class="col-lg-8">
          <div class="table-content table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>Course</th>
                  <th>Price</th>
                </tr>
              </thead>
              <tbody>

                {% for item in cart_items %}
                <tr>
                  <td>
                    <strong>{{ item.course.title }}</strong><br>
                    <small class="text-muted">
                      {{ item.course.level|title }}
                    </small>
                  </td>
                  <td>
                    ${{ item.course.price|intcomma }}
                  </td>
                </tr>
                {% endfor %}

              </tbody>
            </table>
          </div>
        </div>

        <!-- TOTAL -->
        <div class="col-lg-4">
          <div class="cart-page-total">
            <h2>Order Summary</h2>

            <ul class="mb-20">
              <li>
                Subtotal
                <span>${{ total_amount|intcomma }}</span>
              </li>
              <li>
                Total
                <span>${{ total_amount|intcomma }}</span>
              </li>
            </ul>

            <!-- PAYSTACK BUTTON -->
            <button id="payBtn" class="edu-btn w-100">
              Pay with Paystack
            </button>

            <a href="{% url 'cart' %}"
               class="edu-border-btn w-100 mt-10">
              Back to Cart
            </a>

          </div>
        </div>

      </div>

    </div>
  </section>

</main>

<script src="https://js.paystack.co/v1/inline.js"></script>

<script>
document.getElementById("payBtn").addEventListener("click", function () {

  // Step 1: create pending purchases
  fetch("{% url 'checkout' %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}"
    }
  })
  .then(res => {
    if (!res.redirected) {
      throw new Error("Failed to start payment");
    }
    return fetch(res.url); // ðŸ‘ˆ fetch the JSON instead of navigating
  })
  .then(res => res.json())
  .then(data => {

    if (data.error) {
      alert(data.error);
      return;
    }

    // Step 2: open Paystack popup
    const handler = PaystackPop.setup({
      key: data.public_key,
      email: data.email,
      amount: data.amount,
      ref: data.reference,

      callback: function (response) {
        // Step 3: verify payment
        window.location.href = `dashboard/payments/verify/${response.reference}/`;
      },

      onClose: function () {
        alert("Payment cancelled");
      }
    });

    handler.openIframe();
  })
  .catch(err => {
    alert(err.message || "Payment failed");
  });

});
</script>


{% endblock %}
