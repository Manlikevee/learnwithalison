{% extends 'dashlayout.html' %}
{% load static %}
{% block content %}

<div class="container-fluid">

  <!-- PAGE TITLE -->
  <div class="page-title-head d-flex align-items-center">
    <div class="flex-grow-1">
      <h4 class="fs-xl fw-bold m-0">Support Tickets</h4>
    </div>

    <div class="text-end">
      <ol class="breadcrumb m-0 py-0">
        <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
        <li class="breadcrumb-item active">Support Tickets</li>
      </ol>
    </div>
  </div>

  <!-- TICKETS TABLE -->
  <div class="row mt-3">
    <div class="col-12">

      <div data-table data-table-rows-per-page="10" class="card">

        <!-- HEADER -->
        <div class="card-header border-light justify-content-between">
          <div class="d-flex gap-2">
            <div class="app-search">
              <input data-table-search type="search"
                     class="form-control"
                     placeholder="Search tickets...">
              <i data-lucide="search" class="app-search-icon text-muted"></i>
            </div>
          </div>

          <!-- ROWS PER PAGE -->
          <div>
            <select data-table-set-rows-per-page
                    class="form-select form-control my-1 my-md-0">
              <option value="5">5</option>
              <option value="10" selected>10</option>
              <option value="15">15</option>
              <option value="20">20</option>
            </select>
          </div>
        </div>

        <!-- TABLE -->
        <div class="table-responsive">
          <table class="table table-custom table-hover table-centered w-100 mb-0">
            <thead class="bg-light bg-opacity-25 thead-sm">
              <tr class="text-uppercase fs-xxs">
                <th data-table-sort>Ticket ID</th>
                <th data-table-sort>Subject</th>
                <th>User</th>
                <th>Category</th>
                <th>Status</th>
                <th>Priority</th>
                <th data-table-sort>Created</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>

            <tbody>

              {% for ticket in tickets %}
              <tr>

                <td>#{{ ticket.ticket_id }}</td>

                <td class="fw-semibold">
                  {{ ticket.subject }}
                </td>

                <td>
                  {{ ticket.user.email|default:ticket.user.username }}
                </td>

                <td>
                  {{ ticket.category|title }}
                </td>

                <!-- STATUS -->
                <td>
                  <span class="badge fs-xxs fw-semibold
                    {% if ticket.status == 'open' %}
                      bg-info-subtle text-info
                    {% elif ticket.status == 'in_progress' %}
                      bg-warning-subtle text-warning
                    {% elif ticket.status == 'resolved' %}
                      bg-success-subtle text-success
                    {% else %}
                      bg-secondary-subtle text-secondary
                    {% endif %}
                  ">
                    {{ ticket.status|title }}
                  </span>
                </td>

                <!-- PRIORITY -->
                <td>
                  <span class="badge fs-xxs fw-semibold
                    {% if ticket.priority == 'high' %}
                      bg-danger-subtle text-danger
                    {% elif ticket.priority == 'medium' %}
                      bg-warning-subtle text-warning
                    {% else %}
                      bg-secondary-subtle text-secondary
                    {% endif %}
                  ">
                    {{ ticket.priority|title }}
                  </span>
                </td>

                <td>
                  {{ ticket.created_at|date:"d M Y, H:i" }}
                </td>

                <!-- ACTIONS -->
                <td class="text-center">
                  <a href="{% url 'support_ticket_detail' ticket.id %}"
                     class="btn btn-default btn-icon btn-sm"
                     title="View Ticket">
                    <i class="ti ti-eye fs-lg"></i>
                  </a>

                  {% if ticket.status != 'resolved' %}
                  <a href="{% url 'support_ticket_resolve' ticket.id %}"
                     class="btn btn-default btn-icon btn-sm text-success"
                     title="Mark as Resolved"
                     onclick="return confirm('Mark this ticket as resolved?');">
                    <i class="ti ti-check fs-lg"></i>
                  </a>
                  {% endif %}
                </td>

              </tr>
              {% empty %}
              <tr>
                <td colspan="8" class="text-center text-muted py-4">
                  No support tickets found.
                </td>
              </tr>
              {% endfor %}

            </tbody>
          </table>
        </div>

        <!-- FOOTER -->
        <div class="card-footer border-0">
          <div class="d-flex justify-content-between align-items-center">
            <div data-table-pagination-info="tickets"></div>
            <div data-table-pagination></div>
          </div>
        </div>

      </div>

    </div>
  </div>

</div>

{% endblock %}
