{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block content %}

<script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

<main>

<!-- HERO -->
<div class="hero-arera course-item-height"
     data-background="{% static 'images/slider/course-slider.jpg' %}">
  <div class="container">
    <div class="row">
      <div class="col-xl-12">
        <div class="hero-course-1-text">
          <h2>{{ course.title }}</h2>
        </div>
        <div class="course-title-breadcrumb">
          <nav>
            <ol class="breadcrumb">
              <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
              <li class="breadcrumb-item"><a href="{% url 'course_list' %}">Courses</a></li>
              <li class="breadcrumb-item active">{{ course.title }}</li>
            </ol>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>

<section class="course-detalis-area pb-90">
  <div class="container">
    <div class="row">
      {% include 'message.html' %}

      <!-- LEFT -->
      <div class="col-xl-8">

        <div class="course-detalis-wrapper mb-30">

          <h2>{{ course.title }}</h2>

          <div class="course-description pt-45 pb-30">
            <h4>Description</h4>
            <p>{{ course.description|linebreaks }}</p>
          </div>

          <!-- CURRICULUM -->
          <div class="course-curriculum pt-40 pb-50">
            <h4>Curriculum</h4>

            <div class="course-curriculam-accodion mt-30">
              <div class="accordion" id="accordionExample">

                {% for section in sections %}
                <div class="accordion-item">

                  <div class="accordion-header">
                    <button class="accordion-button collapsed"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapse{{ section.id }}">
                      {{ section.title }}
                    </button>
                  </div>

                  <div id="collapse{{ section.id }}" class="accordion-collapse collapse">
                    <div class="accordion-body">

                      {% for lesson in section.lessons.all %}
                      <div class="course-curriculum-content
                                  d-flex justify-content-between align-items-center
                                  {% if has_paid %}lesson-playable{% endif %}"
                           {% if has_paid %}
                           onclick="handleLessonClick(this)"
                           data-title="{{ lesson.title }}"
                           data-is-link="{{ lesson.is_link|yesno:'true,false' }}"
                           {% if lesson.is_link %}
                             data-link="{{ lesson.video_link }}"
                           {% else %}
                             data-video="{{ lesson.video.url }}"
                           {% endif %}
                           {% endif %}>

                        <div class="course-curriculum-info d-flex align-items-center">
                          <ion-icon name="videocam-outline"></ion-icon>
                          <h4 class="mb-0 ms-2">{{ lesson.title }}</h4>
                        </div>

                        <div class="course-curriculum-meta">
                          <span>{{ lesson.duration|default:"--:--" }}</span>

                          {% if has_paid %}
                            <ion-icon name="play-circle-outline" class="text-success"></ion-icon>
                          {% else %}
                            <ion-icon name="lock-closed-outline"></ion-icon>
                          {% endif %}
                        </div>

                      </div>
                      {% endfor %}

                    </div>
                  </div>

                </div>
                {% endfor %}

              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="col-xl-4">
        <div class="course-video-widget">
          <div class="course-widget-wrapper">

            <div class="course-video-thumb w-img">
              {% if course.thumbnail %}
                <img src="{{ course.thumbnail.url }}">
              {% else %}
                <img src="{% static 'images/course/default.jpg' %}">
              {% endif %}
            </div>

            <div class="course-video-price">
              {% if course.price_type == 'free' %}
                <span>Free</span>
              {% else %}
                <span>${{ course.price|intcomma }}</span>
              {% endif %}
            </div>

            <div class="video-wishlist">
{% if has_paid %}
  <button class="video-cart-btn bg-success" disabled>
    Already Purchased
  </button>
{% else %}
  <a href="{% url 'add_to_cart' course.id %}" class="video-cart-btn">
    {% if course.price_type == 'free' %}
      Enroll Now
    {% else %}
      Buy Course
    {% endif %}
  </a>
{% endif %}
            </div>

          </div>
        </div>
      </div>

    </div>
  </div>
</section>

</main>

<!-- VIDEO MODAL -->
<div class="modal fade" id="lessonModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="lessonTitle"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body p-0">
        <video id="lessonVideo" controls style="width:100%;">
          <source src="" type="video/mp4">
        </video>
      </div>

    </div>
  </div>
</div>

<style>
.lesson-playable {
  cursor: pointer;
}
.lesson-playable:hover {
  background: #f5f5f5;
}
</style>

<script>
  let lessonModal;

  document.addEventListener("DOMContentLoaded", function () {
    lessonModal = new bootstrap.Modal(
      document.getElementById("lessonModal")
    );

    document.getElementById("lessonModal")
      .addEventListener("hidden.bs.modal", function () {
        const video = document.getElementById("lessonVideo");
        video.pause();
        video.currentTime = 0;
        video.src = "";
      });
  });

  function handleLessonClick(el) {
    const isLink = el.dataset.isLink === "true";
    const title = el.dataset.title;

    // ðŸ”— LINKED VIDEO
    if (isLink) {
      const link = el.dataset.link;
      if (!link) {
        alert("Video link not available");
        return;
      }
      window.open(link, "_blank");
      return;
    }

    // ðŸŽ¥ UPLOADED VIDEO
    const videoUrl = el.dataset.video;
    if (!videoUrl) {
      alert("Video not available");
      return;
    }

    const video = document.getElementById("lessonVideo");
    const modalTitle = document.getElementById("lessonTitle");

    modalTitle.innerText = title;
    video.src = videoUrl;

    lessonModal.show();
    video.play();
  }
</script>

{% endblock %}
