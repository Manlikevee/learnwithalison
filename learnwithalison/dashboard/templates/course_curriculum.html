{% extends 'dashlayout.html' %}
{% load static %}
{% block content %}

<div class="container-fluid">

  <!-- PAGE TITLE -->
  <div class="page-title-head d-flex align-items-center mb-3">
    <div class="flex-grow-1">
      <h4 class="fs-xl fw-bold m-0">
        Course Curriculum — {{ course.title }}
      </h4>
    </div>

    <div class="d-flex gap-2">
      <a href="{% url 'admin_courses' %}" class="btn btn-success btn-sm">
        Save & Exit
      </a>
      <a href="{% url 'admin_courses' %}" class="btn btn-light btn-sm">
        ← Back to Courses
      </a>
    </div>
  </div>

  <!-- ADD SECTION -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="card-title mb-0">Add Section</h5>
    </div>
    <div class="card-body">
      <form id="sectionForm">
        {% csrf_token %}
        <div class="row g-2">
          <div class="col-md-10">
            <input type="text"
                   name="title"
                   class="form-control"
                   placeholder="Section title (e.g. Introduction)"
                   required>
          </div>
          <div class="col-md-2">
            <button class="btn btn-primary w-100">
              Add Section
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- SECTIONS -->
  {% for section in course.sections.all %}
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">{{ section.title }}</h5>
    </div>

    <div class="card-body">

      <!-- EXISTING LESSONS -->
      {% for lesson in section.lessons.all %}
        <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-2">
          <div>
            <strong>{{ lesson.title }}</strong><br>
            <small class="text-muted">{{ lesson.duration }}</small>
          </div>
          <span class="badge bg-success-subtle text-success">
            Uploaded
          </span>
        </div>
      {% empty %}
        <p class="text-muted">No lessons yet.</p>
      {% endfor %}

      <!-- ADD LESSON -->
      <form class="lesson-form mt-3" enctype="multipart/form-data">
        {% csrf_token %}

        <input type="hidden" name="section" value="{{ section.id }}">
        <input type="hidden" name="duration" class="lesson-duration">
        <input type="hidden" name="is_link" value="false">

        <div class="row g-2 align-items-end">

          <!-- TITLE -->
          <div class="col-md-4">
            <label class="form-label">Lesson Title</label>
            <input type="text"
                   name="title"
                   class="form-control"
                   required>
          </div>

          <!-- SOURCE TOGGLE -->
          <div class="col-md-3">
            <label class="form-label">Video Source</label>
            <select class="form-select video-source">
              <option value="file">Upload Video</option>
              <option value="link">Video Link</option>
            </select>
          </div>

          <!-- FILE INPUT -->
          <div class="col-md-5 video-file">
            <label class="form-label">Video File</label>
            <input type="file"
                   name="video"
                   class="form-control"
                   accept="video/*">
          </div>

          <!-- LINK INPUT -->
          <div class="col-md-5 video-link d-none">
            <label class="form-label">Video Link</label>
            <input type="url"
                   name="video_link"
                   class="form-control"
                   placeholder="https://youtube.com / vimeo / s3 link">
          </div>

          <!-- BUTTON -->
          <div class="col-md-3">
            <button class="btn btn-primary w-100">
              Add Lesson
            </button>
          </div>

        </div>

        <!-- PROGRESS BAR -->
        <div class="progress mt-3 d-none" style="height: 20px;">
          <div class="progress-bar progress-bar-striped progress-bar-animated"
               style="width:0%">
            0%
          </div>
        </div>
      </form>

    </div>
  </div>
  {% endfor %}

</div>

<!-- ================= JAVASCRIPT ================= -->
<script>

/* ================= CREATE SECTION ================= */
document.getElementById("sectionForm").addEventListener("submit", function (e) {
  e.preventDefault();

  const formData = new FormData(this);

  fetch("{% url 'admin_course_section_create' course.id %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
    },
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      location.reload();
    } else {
      alert(data.error || "Failed to create section");
    }
  });
});


/* ================= LESSON UPLOAD ================= */
document.querySelectorAll(".lesson-form").forEach(form => {

  const sourceSelect = form.querySelector(".video-source");
  const fileWrap = form.querySelector(".video-file");
  const linkWrap = form.querySelector(".video-link");
  const isLinkInput = form.querySelector('input[name="is_link"]');

  const videoInput = form.querySelector('input[type="file"]');
  const linkInput = form.querySelector('input[name="video_link"]');
  const durationInput = form.querySelector(".lesson-duration");

  const progress = form.querySelector(".progress");
  const bar = progress.querySelector(".progress-bar");

  /* TOGGLE SOURCE */
  sourceSelect.addEventListener("change", () => {
    const isLink = sourceSelect.value === "link";

    fileWrap.classList.toggle("d-none", isLink);
    linkWrap.classList.toggle("d-none", !isLink);

    isLinkInput.value = isLink ? "true" : "false";
  });

  /* READ DURATION (FILES ONLY) */
  videoInput.addEventListener("change", function () {
    if (!this.files.length) return;

    const video = document.createElement("video");
    video.preload = "metadata";
    video.src = URL.createObjectURL(this.files[0]);

    video.onloadedmetadata = () => {
      URL.revokeObjectURL(video.src);

      const seconds = Math.floor(video.duration);
      const minutes = Math.floor(seconds / 60);
      const remaining = seconds % 60;

      durationInput.value =
        minutes + "m " + String(remaining).padStart(2, "0") + "s";
    };
  });

  /* SUBMIT */
  form.addEventListener("submit", function (e) {
    e.preventDefault();

    const isLink = isLinkInput.value === "true";

    if (isLink && !linkInput.value) {
      alert("Please enter a video link");
      return;
    }

    if (!isLink && !videoInput.files.length) {
      alert("Please select a video file");
      return;
    }

    const formData = new FormData(form);
    const xhr = new XMLHttpRequest();

    xhr.open("POST", "{% url 'admin_course_lesson_upload' course.id %}");
    xhr.setRequestHeader(
      "X-CSRFToken",
      document.querySelector("[name=csrfmiddlewaretoken]").value
    );

    progress.classList.remove("d-none");
    bar.className = "progress-bar progress-bar-striped progress-bar-animated";
    bar.style.width = "0%";
    bar.textContent = "0%";

    xhr.upload.onprogress = e => {
      if (e.lengthComputable) {
        const percent = Math.round((e.loaded / e.total) * 100);
        bar.style.width = percent + "%";
        bar.textContent = percent + "%";
      }
    };

    xhr.onload = () => {
      try {
        const res = JSON.parse(xhr.responseText);
        if (xhr.status === 200 && res.success) {
          bar.classList.remove("progress-bar-animated");
          bar.classList.add("bg-success");
          bar.textContent = "Lesson added";
          setTimeout(() => location.reload(), 600);
        } else {
          throw new Error(res.error || "Upload failed");
        }
      } catch (err) {
        bar.classList.add("bg-danger");
        bar.textContent = "Failed";
        alert(err.message);
      }
    };

    xhr.onerror = () => {
      bar.classList.add("bg-danger");
      bar.textContent = "Error";
      alert("Network error. Please try again.");
    };

    xhr.send(formData);
  });

});
</script>

{% endblock %}
