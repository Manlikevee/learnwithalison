{% extends 'authlayout.html' %}
{% load static %}

{% block hero_title %}Set New Password{% endblock %}
{% block hero_breadcrumb %}Password Reset{% endblock %}

{% block auth_content %}

<div class="row justify-content-center">
  <div class="col-md-6">
    <div class="signup-form-wrapper">

      {% if validlink %}
        <h3 class="text-center">Set New Password</h3>

        <form method="POST" id="resetPasswordForm">
          {% csrf_token %}

          <div class="signup-wrapper">
            <input
              type="password"
              id="password1"
              name="new_password1"
              placeholder="New password"
              required
            >
          </div>

          <div class="signup-wrapper">
            <input
              type="password"
              id="password2"
              name="new_password2"
              placeholder="Confirm new password"
              required
            >
          </div>

          <!-- Password rules -->
          <ul id="passwordRules" style="font-size: 14px; margin-bottom: 15px;">
            <li id="length" class="text-danger">At least 8 characters</li>
            <li id="uppercase" class="text-danger">One uppercase letter</li>
            <li id="lowercase" class="text-danger">One lowercase letter</li>
            <li id="number" class="text-danger">One number</li>
            <li id="special" class="text-danger">One special character</li>
            <li id="match" class="text-danger">Passwords match</li>
          </ul>

          <div class="sign-button mb-20">
            <button type="submit" id="submitBtn" class="sign-btn" disabled>
              Reset Password
            </button>
          </div>
        </form>

      {% else %}
        <p class="text-center text-danger">
          This password reset link is invalid or has already been used.
        </p>

        <div class="sign-button text-center mt-20">
          <a href="{% url 'password_reset' %}" class="sign-btn">
            Request New Link
          </a>
        </div>
      {% endif %}

    </div>
  </div>
</div>

<!-- ðŸ” Password Strength Script -->
<script>
  const password1 = document.getElementById('password1');
  const password2 = document.getElementById('password2');
  const submitBtn = document.getElementById('submitBtn');

  const rules = {
    length: document.getElementById('length'),
    uppercase: document.getElementById('uppercase'),
    lowercase: document.getElementById('lowercase'),
    number: document.getElementById('number'),
    special: document.getElementById('special'),
    match: document.getElementById('match'),
  };

  function validatePassword() {
    const p1 = password1.value;
    const p2 = password2.value;

    const checks = {
      length: p1.length >= 8,
      uppercase: /[A-Z]/.test(p1),
      lowercase: /[a-z]/.test(p1),
      number: /[0-9]/.test(p1),
      special: /[^A-Za-z0-9]/.test(p1),
      match: p1 && p1 === p2,
    };

    let valid = true;

    for (const rule in checks) {
      if (checks[rule]) {
        rules[rule].classList.remove('text-danger');
        rules[rule].classList.add('text-success');
      } else {
        rules[rule].classList.remove('text-success');
        rules[rule].classList.add('text-danger');
        valid = false;
      }
    }

    submitBtn.disabled = !valid;
  }

  password1.addEventListener('input', validatePassword);
  password2.addEventListener('input', validatePassword);
</script>

{% endblock %}
